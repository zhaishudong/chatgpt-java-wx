import{k as e,n as s,l as t,m as a,e as n,o,f as r,p as c,F as i,g as u,a as l,q as d,w as m,u as h,v as p,I as g,j as b,b as k,t as x}from"./index-80193a4d.js";import{e as v}from"./env.5ec900c0.js";import{r as f,_ as y}from"./_plugin-vue_export-helper.81ad42bd.js";let T;function w(e){return f({url:"/user/logout",method:"GET",data:{username:e}})}const S=y({data:()=>({messageList:[],userInput:""}),onLoad(){const a=e("expireTime"),n=e("username");e("key"),a||s({url:"/pages/index/login"}),Date.now()>a&&(t("expireTime"),t("key"),t("username"),w({username:n}).then((()=>{s({url:"/pages/index/login"})})))},mounted(){const e=localStorage.getItem("messageList");e&&(this.messageList=JSON.parse(e)),this.$router.beforeEach(((e,s,t)=>{"Chat"===e.name&&this.connectWebSocket(),t()}))},beforeUnmount(){this.socket&&this.socket.close()},onShow(){const n=e("expireTime"),o=e("username"),r=e("key");var c;n||s({url:"/pages/index/login"}),Date.now()>n?(t("expireTime"),t("key"),t("username"),w({username:o}).then((()=>{s({url:"/pages/index/login"})}))):(c={username:o,key:r},f({url:"/user/checkUserKey",method:"POST",data:c})).then((e=>{e.code>=200?function(e){return new Promise(((s,t)=>{T&&T.close();const a=v.BASE_WS+e;T=new WebSocket(a),T.onopen=()=>{console.log("WebSocket 已连接"),s()},T.onmessage=e=>{console.log("收到消息：",e.data);const s={text:e.data,sender:"bot"};messageList=localStorage.getItem("messageList"),this.messageList.push(s)},T.onclose=()=>{console.log("WebSocket 断开连接")},T.onerror=()=>{t(new Error("WebSocket 连接错误"))}}))}(o).then((()=>{a({title:"建立会话成功",icon:"success",duration:500})})):(t("expireTime"),t("key"),t("username"),s({url:"/pages/index/login"}))}))},methods:{copyText(e){const s=document.createElement("textarea");s.value=e,document.body.appendChild(s),s.select(),document.execCommand("copy"),document.body.removeChild(s),a({title:"复制成功",icon:"none"})},connectWebSocket(){},sendMessage(){if(""!==this.userInput){this.messageList.push({text:this.userInput,sender:"user"});const e=this.messageList.map((e=>e.text)),s=this.userInput;this.sendChatMessage(e,s),this.userInput=""}},sendChatMessage(e,s){const t=this;var a;T.onmessage=e=>{console.log("收到消息：",e.data);const s={text:e.data,sender:"bot"};t.messageList.push(s),t.$nextTick((()=>{const e=t.$refs.chatWindow;e.scrollTop=e.scrollHeight}))},a=s,T&&T.readyState===WebSocket.OPEN&&T.send(a),this.$nextTick((()=>{const e=this.$refs.chatWindow;e.scrollTop=e.scrollHeight}))}},setup(){const e=n("chat");return{currentTab:e,switchTab:function(t){e.value=t,"chat"===t?s({url:"/pages/chat/chat"}):"user"===t&&p({url:"/pages/user/user"})}}}},[["render",function(e,s,t,a,n,p){const v=g,f=b;return o(),r("div",{class:"container"},[c("div",{class:"chat-window",ref:"chatWindow"},[(o(!0),r(i,null,u(n.messageList,((e,s)=>(o(),r("div",{class:h(["message",{"user-message":"user"===e.sender,"bot-message":"bot"===e.sender}]),key:"message"+s,ref_for:!0,ref:"message",onDblclick:s=>p.copyText(e.text)},["bot"===e.sender?(o(),r("span",{key:0,class:"sender-name"},"智能助手：")):(o(),r("span",{key:1,class:"sender-name"},"我：")),k(" "+x(e.text),1)],42,["onDblclick"])))),128))],512),c("div",{class:"input-box"},[l(v,{type:"text",class:"message-input",modelValue:n.userInput,"onUpdate:modelValue":s[0]||(s[0]=e=>n.userInput=e),onKeyup:d(p.sendMessage,["enter","native"]),placeholder:"输入你的消息"},null,8,["modelValue","onKeyup"]),l(f,{class:"send-button",onClick:p.sendMessage},{default:m((()=>[k("发送")])),_:1},8,["onClick"])]),c("div",{class:"nav-bar"},[c("div",{class:h(["nav-item",{active:"chat"===a.currentTab}]),onClick:s[1]||(s[1]=e=>a.switchTab("chat"))}," 聊天 ",2),c("div",{class:h(["nav-item",{active:"user"===a.currentTab}]),onClick:s[2]||(s[2]=e=>a.switchTab("user"))}," 我的 ",2)])])}],["__scopeId","data-v-28510a28"]]);export{S as default};
